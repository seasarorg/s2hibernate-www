<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<!-- don't edit start -->
<head>
<title>Seasar - DI Container with AOP -</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen" />
<link href="seasar_p.css" type="text/css" rel="stylesheet" media="print" />
<script src="seasar_b.js" type="text/JavaScript" language="JavaScript">
</script>
</head>
<body onload="preload('ja')">
<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left">
<tr>
<td align="left" valign="top" width="780">
<table width="780" border="0" cellspacing="0" cellpadding="0" class="white">

<tr>
<td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt="" /></td>
</tr>
<tr>
<td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar" /></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP" /></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt="" /></td>
</tr>
<tr>
<td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235" /></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)" name="menu01" /></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)" name="menu02" /></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)" name="menu03" /></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)" name="menu04" /></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)" name="menu05" /></td>
<td><img height="30" width="34" src="images/menu06.gif" alt="" /></td>
</tr>

<tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt="" /></td>
</tr>
</table>
<table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top">
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt="" /></td>
<td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>
    このドキュメントはS2Hibernate-JPAのバージョン1.0.0-rc2のものです。<br/>
</p>

<ul>	
<li><a href="#Overview">概要</a></li>
<li><a href="#Reference">リファレンス</a>
<ul>
<li><a href="#Setup">セットアップ</a></li>
<li><a href="#Usage">基本的な使い方</a>
<ul>
<li><a href="#Entity">エンティティ</a></li>
<li><a href="#dao">Dao(Data Access Object)</a></li>
<li><a href="#diconFile">diconファイル</a></li>
<li><a href="#persistence.xml">persistence.xml</a></li>
</ul>
</li>
<li><a href="#autoDetectionAndAutoRegister">永続クラスとマッピングファイルの自動検出/自動登録</a>
<ul>
<li><a href="#autoDetection">自動検出</a></li>
<li><a href="#autoRegister">永続ユニットごとの自動登録</a></li>
</ul>
</li>
<li><a href="#multiple">複数の永続ユニットの使い方</a></li>
<li><a href="#test">効率的なテストの実行方法</a><ul>
<li><a href="#env.txt">env.txt</a></li>
<li><a href="#testPersistence.xml">テスト用のpersistence.xml</a></li>
</ul>
</li>
<li><a href="#mappingTest">S2JUnit4を使った複雑なマッピングのテスト</a>
<ul>
<li><a href="#mappingTestSample">サンプルコード</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<h2><a name="Overview">概要</a></h2>
<p>S2Hibernate-JPAは以下の特徴を持っています。</p>
<ul>
<li>Seasar2で管理されているJava Transaction API (JTA)やConnectionPoolと<a href="http://www.hibernate.org/">Hibernate3</a> + <a href="http://annotations.hibernate.org/">Hibernate Annotations</a> + <a href="http://entitymanager.hibernate.org/">Hibernate EntityManager</a>が簡単に連動するようになります。</li>
<li>アプリケーションサーバが無くても､簡単にEJB3のJava Persistence API (JPA)を利用ができます。</li>
<li><a href="http://s2container.seasar.org/ja/S2.4SmartDeploy.html">SMART deploy</a>を利用することで永続ユニットごとに永続クラスとマッピングファイルを自動登録できます。
</li>
<li>Hibernate EntityManagerを使ったテストの時間を短縮できます。</li>
    <li><a href="http://s2container.seasar.org/ja/S2JUnit4.html">S2JUnit4</a>を使って複雑なマッピングのテストができます。 </li>
</ul>

<h2><a name="Reference">リファレンス</a></h2>
<h3><a name="Setup">セットアップ</a></h3>
<ul>
<li>プロジェクトのインポート<br/>
	JDK5以上が必要です。<br/>
	あらかじめ<a href="http://s2container.seasar.org/ja/">Seasar2とS2-Tiger</a>をダウンロードして、EclipseのJavaプロジェクトとしてワークスペースにインポートしてください。<br/>
	S2Hibernate-JPA-x.x.x.zipを解凍してできたs2hibernate-jpaディレクトリをEclipseのJavaプロジェクトとしてワークスペースにインポートしてください。<br/>
</li>
<li>必要なjarファイル<br/>
    S2Hibernate-JPAとして必要なjarファイルは、s2hibernate-jpa/libにそろっています（ただし、h2-x.x.x.jarはテスト用であるため動作に必須ではありません。）。この他に<a href="http://s2container.seasar.org/ja/">Seasar2およびS2-Tiger</a>のjarファイルが必要です。<br/>
	Hibernate3はコネクションプールやキャッシュの実装をいろいろ選べるようになっているので、S2Hibernate-JPAで用意していない実装が必要な場合は、<a href="http://www.hibernate.org/">Hibernateのサイト</a>よりダウンロードしてください。<br/>
</li>
<li>クラスパス<br/>
	以下のファイルにクラスパスを通します。resourcesのファイル（特にconvention.diconとjdbc.dicon）はプロジェクトに適した設定に変更し使用してください。
	<ul>
	<li>s2hibernate-jpa/libのjarファイル</li>
	<li>s2hibernate-jpa/resources(jpa.dicon、META-INF/persistence.xml)</li>
	<li>Seasar2のresources(convention.dicon、creator.dicon、customizer.dicon、jdbc.dicon、log4.properties)<br/></li>
	</ul>
</li>

<li>データベース<br/>
    簡単に機能を試すことができるように、RDBMSである<a href="http://www.h2database.com/html/frame.html">H2 Database Engine</a>(h2-x.x.x.jar)がS2Hibernate-JPAに含まれています。
</li>
</ul>


<h3><a name="Usage">基本的な使い方</a></h3>
<p>
    S2Hibernate-JPAの機能を使用するにあたり、エンティティ、Dao(.java)、diconファイル、persistence.xmlの作成が必要になります。
</p>

<h4><a name="Entity">エンティティ</a></h4>
<p>Persistence APIの仕様に合わせてエンティティを作成します。 
</p>
<p>
    エンティティクラスの自動検出と永続ユニットへの自動登録を行うためにエンティティはエンティティパッケージに配置します。詳細は<a href="#autoDetectionAndAutoRegister">永続クラスとマッピングファイルの自動検出/自動登録</a>を参照してください。</p>

<h4><a name="dao">Dao(Data Access Object)</a></h4>
<p>Daoの実装方法</p>
<ul>
<li>EntityManager型のフィールドを定義します。
<pre>private EntityManager entityManager;</pre></li>
<li>コンストラクタあるいはプロパティ経由で実装オブジェクトを受け取るように記述します。<pre>public void setEntityManager(EntityManager entityManager) { 
    this.entityManager = entityManager;
}</pre>
    または、JPAのPersistenceContextアノテーションを利用したインジェクションも可能です。
<pre>@PersistenceContext
private EntityManager entityManager;</pre>
</li>
<li>各メソッドでEntityManagerに対する処理を記述します。
<pre>public Employee getEmployee(int empno) {
    return entityManager.find(Employee.class, 7788);
}</pre>
</li>
</ul>

<h4><a name="diconFile">diconファイル</a></h4>
<p>
    SMART deployに必要なconvention.dicon、creator.dicon、customizer.diconを設定します。設定方法は<a href="http://s2container.seasar.org/ja/S2.4SmartDeploy.html#DiconConfSample">diconファイルの設定例</a>を参照してください。
</p>
<p>
    jpa.diconを設定します（以下のjpa.diconはs2hibernate-jpa/resourcesに含まれるものと同一です）。jpa.diconは他のdiconファイルやテストクラスで<a href="http://s2container.seasar.org/ja/DIContainer.html#Include">インクルード</a>して利用します。
</p>
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE components PUBLIC &quot;-//SEASAR//DTD S2Container 2.4//EN&quot; 
  &quot;http://www.seasar.org/dtd/components24.dtd&quot;&gt;
&lt;components&gt;
  &lt;include path=&quot;s2hibernate-jpa.dicon&quot;/&gt;

  &lt;component name=&quot;entityManagerFactory&quot; class=&quot;javax.persistence.EntityManagerFactory&quot;&gt;
    jpa.persistenceUnitManager.getEntityManagerFactory(&quot;<b>persistenceUnit</b>&quot;)
  &lt;/component&gt;

  &lt;component name=&quot;entityManager&quot; 
      class=&quot;org.seasar.framework.jpa.impl.TxScopedEntityManagerProxy&quot;/&gt;

  &lt;component class=&quot;org.seasar.hibernate.jpa.metadata.HibernateEntityDescProvider&quot;/&gt;

  &lt;!-- for test --&gt;
  &lt;component name=&quot;<b>dataSourceProxy</b>&quot; 
      class=&quot;org.seasar.extension.datasource.impl.SingletonDataSourceProxy&quot;/&gt;
&lt;/components&gt;
</pre>

<p>
jpa.persistenceUnitManager.getEntityManagerFactory()に渡す永続ユニット名はpersistence.xmlの定義と一致させてください。
</p>
<p>
    dataSourceProxyはテスト用のコンポーネントです。 このコンポーネントについては<a href="#test">効率的なテストの実行方法</a>にて説明します。</p>

<h4><a name="persistence.xml">persistence.xml</a></h4>
<p>クラスパスの通っているディレクトリにMETA-INFディレクトリを作成します。META-INFには、次のようなpersistence.xmlを格納します。</p>
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;persistence&gt;
    &lt;persistence-unit name=&quot;<b>persistenceUnit</b>&quot; transaction-type=&quot;JTA&quot;&gt;
        &lt;jta-data-source><b>jdbc/dataSource</b>&lt;/jta-data-source&gt;
        &lt;provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider&gt;
        &lt;properties&gt;
            &lt;property name=&quot;hibernate.dialect&quot; 
                value=&quot;org.hibernate.dialect.HSQLDialect&quot;/&gt;
            &lt;property name=&quot;hibernate.jndi.class&quot; 
                value=&quot;org.seasar.extension.j2ee.JndiContextFactory&quot;/&gt;
            &lt;property name=&quot;hibernate.transaction.manager_lookup_class&quot; 
                value=&quot;org.seasar.hibernate.jpa.transaction.S2TransactionManagerLookup&quot;/&gt;
            &lt;property name=&quot;hibernate.show_sql&quot; 
                value=&quot;false&quot;/&gt;
            &lt;property name=&quot;hibernate.format_sql&quot; 
                value=&quot;true&quot;/&gt;
            &lt;property name=&quot;hibernate.use_sql_comments&quot; 
                value=&quot;false&quot;/&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>
<p>
    永続ユニット名にはpersistenceUnitと指定します。</p>
<p>
データソース名は、jdbc.diconの<var>名前空間名.dataSourceコンポーネント名</var>と一致させてください。 ここではjdbc/dataSourceと指定しています。
</p>

<h3><a name="autoDetectionAndAutoRegister">永続クラスとマッピングファイルの自動検出/自動登録</a></h3>
<p>
S2Hibernate-JPAは、<a href="http://s2container.seasar.org/ja/S2.4SmartDeploy.html">SMART deploy</a>を利用することでエンティティパッケージに置かれた永続クラスやマッピングファイルを自動検出し永続ユニットに自動登録できます。
</p>
<p>
「エンティティパッケージ」とは<code>convention.dicon</code>に指定したルートパッケージの直下の個別パッケージ名が「<code>entity</code>」であるパッケージのことです。たとえば、ルートパッケージ名が「<code>example</code>」の場合、エンティティパッケージは「<code>example.entity</code>」となります。
「永続クラス」とは<code>Entity</code>アノテーション、<code>Embeddable</code>アノテーション、<code>MappedSuperclass</code>アノテーションのいずれかが付与されたクラスを指します。「マッピングファイル」とはJPAのマッピングファイルを意味します。
</p>

<h4><a name="autoDetection">自動検出</a></h4>
<p>
    永続クラスを自動検出するには次の条件を満たす必要があります。
</p>
<ul>
<li>SMART deployが有効である </li>
<li>エンティティクラスがエンティティパッケージまたはエンティティパッケージのサブパッケージに存在する </li>
</ul>
<p>
マッピングファイルを自動検出するには次の条件を満たす必要があります。
</p>
<ul>
<li>SMART deployが有効である </li>
<li>マッピングファイルがエンティティパッケージまたはエンティティパッケージのサブパッケージに存在する </li>
<li>マッピングファイルの名称が<code><var>Xxx</var>Orm.xml</code>(<coe><var>Xxx</var></code>は任意の名称)である </li>
</ul>
    <p>
        SMART deployが有効である場合、S2Hibernate-JPAはS2Hibernate-JPAによる自動検出を優先し、Hibernateの自動検出機能を無効にします。したがって、Hibernateの独自マッピングファイル（<code>.hbm.xml</code>）は自動検出されません。</p>
    <p>
        なお、JPA標準のマッピングファイルである<code>META-INF/orm.xml</code>は、SMART deployの有効/無効にかかわらずHibernate EntityManagerにより自動的に読み込まれます。</p>
    
<h4>永続ユニットごとの自動登録</h4>
<p>
    自動検出されたエンティティクラスとマッピングファイルは以下の規則により特定の永続ユニットに登録されます。この規則は複数の永続ユニットを同時に利用する場合に特に重要です。複数の永続ユニットを使う場合の設定については<a href="#multiple">複数の永続ユニットの使い方</a>を参照してください。</p>
    <p>
        永続クラスもしくはマッピングファイルがエンティティパッケージ直下に置かれている場合、それらはデフォルトの永続ユニット（<code>persistenceUnit</code>）に登録されます。</p>
    <p>
        永続クラスもしくはマッピングファイルがエンティティパッケージのサブパッケージに置かれている場合、それらは<code><var>xxx</var>PersistenceUnit</code>(<code><var>xxx</var></code>はサブパッケージ名)という名前の永続ユニットに登録されます。</p>
    <p>
        なお、JPA標準のマッピングファイルである<code>META-INF/orm.xml</code>は、Hibernate EntityManagerによりすべての永続ユニットに自動的に登録されます。<br />
    </p>    
<h5><a name="autoRegister">自動登録の例</a></h5>
<p>
    エンティティパッケージがexample.entityである場合、エンティティパッケージに属するHogeクラスとサブパッケージに属するBarクラスはそれぞれ特定の永続ユニットに登録されます。&nbsp;</p>
<table border="1">
<tbody><tr align="center" bgcolor="#d1f3f4">
<th style="width: 266px">
    登録対象である永続クラスの完全修飾名</th>
<th style="width: 182px">
    登録先の永続ユニット名</th>
    <th style="width: 273px">
        説明</th>
</tr>
<tr><td align="center" style="width: 266px; height: 24px;">
    example.entity.Hoge</td><td align="center" style="width: 182px; height: 24px;">
    persistenceUnit</td><td style="width: 273px; height: 24px;">
        デフォルトの永続ユニットである「<code>persistenceUnit</code>」に登録されます。</td>
</tr>
<tr><td align="center" style="width: 266px">
    example.entity.foo.Bar</td><td align="center" style="width: 182px">
    fooPeristenceUnit</td><td style="width: 273px">
        サブパッケージ「<code>foo</code>」とサフィックス「<code>PersistenceUnit</code>」を組み合わせた名称を持つ永続ユニット「<code>fooPersistenceUnit</code>」に登録されます。</td>
</tr>

</tbody></table>

<h3><a name="multiple">複数の永続ユニットの使い方</a></h3>

<p>
複数のJPA実装を使う場合や、複数のJDBC DataSourceを使う場合は、複数の永続ユニットを作成します。そして、それぞれの永続ユニットに対応する<code>jpa.dicon</code>のコピーを用意し、<code>jpa.dicon</code>からインクルードします。
</p>
<ul>
<li><code>persistence.xml</code>に複数の永続ユニットを定義します。
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;persistence&gt;
    &lt;persistence-unit name=&quot;<b>persistenceUnit</b>&quot; transaction-type=&quot;JTA&quot;&gt;
        &lt;jta-data-source><b>jdbc/dataSource</b>&lt;/jta-data-source&gt;
    ．．．
    &lt;/persistence-unit&gt;
    &lt;persistence-unit name=&quot;<b>fooPersistenceUnit</b>&quot; transaction-type=&quot;JTA&quot;&gt;
        &lt;jta-data-source><b>jdbc/fooDataSource</b>&lt;/jta-data-source&gt;
    ．．．
    &lt;/persistence-unit&gt;</pre>
</li>
<li><code>pu.dicon</code>を定義します。<code>jpa.dicon</code>をコピーし、次のようにします。
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE components PUBLIC &quot;-//SEASAR//DTD S2Container 2.4//EN" 
    "http://www.seasar.org/dtd/components24.dtd"&gt;
&lt;components&gt;
    ．．．
    &lt;component name=&quot;entityManagerFactory&quot; class=&quot;javax.persistence.EntityManagerFactory&quot;&gt;
        jpa.persistenceUnitManager.getEntityManagerFactory(&quot;persistenceUnit&quot;)
    &lt;/component&gt;

    &lt;component name=&quot;entityManager&quot; 
        class=&quot;org.seasar.framework.jpa.TxScopedEntityManagerProxy&quot;/&gt;</pre>
</li>
<li><code>foo-pu.dicon</code>を定義します。<code>jpa.dicon</code>をコピーし、次のようにします。
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE components PUBLIC &quot;-//SEASAR//DTD S2Container 2.4//EN" 
    "http://www.seasar.org/dtd/components24.dtd"&gt;
&lt;components&gt;
    ．．．
    &lt;component name=&quot;<b>fooEntityManagerFactory</b>&quot; class=&quot;javax.persistence.EntityManagerFactory&quot;&gt;
        jpa.persistenceUnitManager.getEntityManagerFactory(&quot;<b>fooPersistenceUnit</b>&quot;)
    &lt;/component&gt;

    &lt;component name=&quot;<b>fooEntityManager</b>&quot; 
        class=&quot;org.seasar.framework.jpa.TxScopedEntityManagerProxy&quot;/&gt;</pre>
</li>
<li>jpa.diconを書き換え<code>pu.dicon</code>と<code>foo-pu.diconをインクルードします。
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE components PUBLIC &quot;-//SEASAR//DTD S2Container 2.4//EN" 
    "http://www.seasar.org/dtd/components24.dtd"&gt;
&lt;components&gt;
  &lt;include path="<b>pu.dicon</b>"/&gt;
  &lt;include path="<b>foo-pu.dicon</b>"/&gt;
&lt;/components&gt;</pre>
</li>
<li>エンティティマネジャーを使用するDaoのクラスはプロパティでオブジェクトを受け取ります。プロパティ名には使用したいエンティティマネージャーのコンポーネント名を使用してください。
<pre>public void setFooEntityManager(EntityManager fooEntityManager) { 
    this.<b>fooEntityManager</b> = fooEntityManager;
}</pre>
    または、JPAのPersistenceContextアノテーションを使用してエンティティマネージャーをインジェクションします。unitName要素には使用したい永続コンテキストの名称を指定してください。
<pre>@PersistenceContext(unitName="<b>fooPersistenceUnit</b>")
private EntityManager em</pre>
</li>
</ul>
<h3><a name="test">効率的なテストの実行方法</a></h3>
<p>
    Hibernate EntityManagerを利用したテストを実行すると、テストケース毎にEntitiyMnanagerFactoryが初期化されるためテストケースが多いと時間がかかります。これを避けるため、S2Hibernate-JPAではEntitiyMnanagerFactoryをキャッシュしテストケース間で共有する仕組みを提供します。
    このキャッシュを有効にするためにはenv.txtの設定とpersistence.xmlの設定が必要です。設定が正しく行われたかどうかはテストケース毎のログ出力から確認できます。</p>

<h4><a name="env.txt">env.txt</a></h4>
<p>
    env.txtファイルをクラスパス上に配置します。env.txtにはutから始まる任意の名称を記述してください。たとえば、「ut」や「ut-hoge」などです。
</p>

<h4><a name="testPersistence.xml">テスト用のpersistence.xml</a></h4>
<p>
    キャッシュされたEntitiyMnanagerFactoryからS2Containerに管理されたDataSourceやTransactionManagerに適切にアクセスできるようにテスト用のpersistence.xmlを使用します。</p>
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;persistence&gt;
    &lt;persistence-unit name=&quot;persistenceUnit&quot; transaction-type=&quot;JTA&quot;&gt;
        &lt;jta-data-source&gt;<b>dataSourceProxy</b>&lt;/jta-data-source&gt;
        &lt;provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider&gt;
        &lt;properties&gt;
            &lt;property name=&quot;hibernate.dialect&quot; 
                value=&quot;org.hibernate.dialect.HSQLDialect&quot;/&gt;
            &lt;property name=&quot;hibernate.jndi.class&quot; 
                value=&quot;org.seasar.extension.j2ee.JndiContextFactory&quot;/&gt;
            &lt;property name=&quot;hibernate.transaction.manager_lookup_class&quot; 
                value=&quot;<b>org.seasar.hibernate.jpa.transaction.S2TransactionManagerLookupTest</b>&quot;/&gt;
            &lt;property name=&quot;hibernate.show_sql&quot; 
                value=&quot;false&quot;/&gt;
            &lt;property name=&quot;hibernate.format_sql&quot; 
                value=&quot;true&quot;/&gt;
            &lt;property name=&quot;hibernate.use_sql_comments&quot; 
                value=&quot;false&quot;/&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>
<p>
データソース名にはjpa.diconに定義された<code>org.seasar.extension.datasource.impl.SingletonDataSourceProxy</code>のコンポーネント名を指定してください。
</p>
<p>
hibernate.transaction.manager_lookup_classプロパティには<code>org.seasar.hibernate.jpa.transaction.S2TransactionManagerLookupTest</code>を指定してください。
</p>
<h3><a name="mappingTest">S2JUnit4を使った複雑なマッピングのテスト</a></h3>
<p>
    JPAではさまざまなマッピング方法がサポートされていますが、継承を使ったマッピングなどは意図通りにマッピングできたかテストするのが難しいことがあります。<a href="http://s2container.seasar.org/ja/S2JUnit4.html">S2JUnit4</a>を利用すると、エンティティを表形式(Seasar2のDataSet)に変換でき、Excelで用意した期待値と比較可能なのでテストが容易です。</p>

<h4><a name="mappingTestSample">サンプルコード</a></h4>    
<p>
    以下のコードはS2Hibernate-JPAに含まれるサンプルコード（examples.entityreader.FileTest.java）からの抜粋です。
</p>    
<pre>import static <b>org.seasar.framework.unit.S2Assert.*</b>;

@RunWith(Seasar2.class)
public class FileTest {
    
    private TestContext context;
    private EntityManager em;
    ．．．
    public void polymorphicQuery() throws Exception {
        Folder root = new Folder();
        root.setName("root");
        Folder folder = new Folder();
        folder.setName("folder");
        folder.setParent(root);
        Document document = new Document();
        document.setName("document");
        document.setSize(100);
        document.setParent(folder);
        folder.getChildren().add(document);

        em.persist(root);
        em.persist(folder);
        em.persist(document);

        Query query = em.createQuery("SELECT f FROM File f ORDER BY f.name");
        <b>assertEntityEquals</b>(context.getExpected(), query.getResultList());
    }
}</pre> 
<p>
このコードにはFolderクラスとDocumentクラスが登場しますが、これらはともにFileクラスを継承したエンティティです。さらにFileクラスもエンティティであり、継承戦略にはJoined Subclassが使用されています。したがって、このテストで実行されるJPQLは3つのテーブルにまたがるデータを返します。org.seasar.framework.unit.S2AssertクラスのassertEntityEqualsを使用することで、3つのテーブルにまたがるデータを含んだ期待値（context.getExpected()で取得）とJPQLの戻り値（query.getResultList()で取得）を比較検証することができます。</p>   
<p>
    S2AssertクラスにはオーバーロードされたstaticなassertEntityEqualsメソッドが4つあります。期待値にはDataSetを、実際値には次のいずれかの値を渡すことができます。</p>
<ul>
<li>単一のエンティティ</li>
<li>エンティティを要素とするコレクション</li><li>エンティティのオブジェクト配列を要素とするコレクション </li>
</ul>
<!-- document end -->
<!-- don't edit start --></td>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt="" /></td>
</tr>
<tr>
<td width="14"><img height="30" width="14" src="images/spacer.gif" alt="" /></td>
<td width="766"><img height="30" width="592" src="images/spacer.gif" alt="" /></td>
</tr>
<tr>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt="" /></td>
<td width="766" class="copyright">Copyright© 2004-2005, The Seasar Foundation and the others. All rights reserved.</td>
</tr>
</table>
</td>
<td class="backright" align="left" valign="top">&nbsp;</td>

</tr>
<tr>
<td class="backunder" align="left" valign="top" width="780" height="16">&nbsp;</td>
<td class="backcorner" align="left" valign="top" height="16">&nbsp;</td>
</tr>
</table>
<!-- don't edit end -->
</body>
</html>

